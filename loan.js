// üî¥ ‡πÉ‡∏™‡πà URL ‡πÅ‡∏•‡∏∞ Key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏à‡∏≤‡∏Å app.js ‡∏°‡∏≤) üî¥
const SUPABASE_URL = 'https://yqlyxzowfbowznpzapxf.supabase.co'; 
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlxbHl4em93ZmJvd3pucHphcHhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwMTc3NDEsImV4cCI6MjA3ODU5Mzc0MX0.ZhJAq0mt3LAamCZlBGux_fwhyQIlOab_0BFsaWubHko';

// üåü ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏õ‡πá‡∏ô supabaseClient (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ä‡∏ô‡∏Å‡∏±‡∏ö Library ‡∏´‡∏•‡∏±‡∏Å)
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const notebookSelect = document.getElementById('notebookSelect');
const borrowerNameInput = document.getElementById('borrowerName');
const borrowerDeptInput = document.getElementById('borrowerDept');

// --- ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î Notebook ‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ ---
window.onload = loadAvailableNotebooks;

async function loadAvailableNotebooks() {
    notebookSelect.innerHTML = '<option value="">-- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î... --</option>';

    // üåü ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏ä‡πâ supabaseClient
    const { data, error } = await supabaseClient
        .from('computers')
        .select('computer_id, spec')
        .eq('asset_type', 'Notebook')
        .is('user_id', null)
        .is('loan_borrower_name', null)
        .order('computer_id');

    if (error) {
        notebookSelect.innerHTML = '<option value="">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î</option>';
        alert(error.message);
        return;
    }

    if (data.length === 0) {
        notebookSelect.innerHTML = '<option value="">-- ‡πÑ‡∏°‡πà‡∏°‡∏µ Notebook ‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ --</option>';
        return;
    }

    notebookSelect.innerHTML = '<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á --</option>';
    data.forEach(com => {
        const option = document.createElement('option');
        option.value = com.computer_id;
        option.textContent = `${com.computer_id} (${com.spec || 'N/A'})`;
        notebookSelect.appendChild(option);
    });
}

// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏° ---
async function submitLoan() {
    const selectedComputerId = notebookSelect.value;
    const borrowerName = borrowerNameInput.value.trim();
    const borrowerDept = borrowerDeptInput.value.trim();

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    if (!selectedComputerId) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Notebook ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°');
        return;
    }
    if (!borrowerName || !borrowerDept) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏Å‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°');
        return;
    }

    if (!confirm(`‡∏Ñ‡∏∏‡∏ì ${borrowerName} (${borrowerDept}) \n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ${selectedComputerId} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
        return;
    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    const loanInfo = `${borrowerName} (${borrowerDept}) - Loaned ${new Date().toLocaleDateString('en-US')}`;

    try {
        // 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á computers
        // üåü ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏ä‡πâ supabaseClient
        const { error: comError } = await supabaseClient
            .from('computers')
            .update({ loan_borrower_name: loanInfo })
            .eq('computer_id', selectedComputerId);

        if (comError) throw comError;

        // 2. ‡πÄ‡∏û‡∏¥‡πà‡∏° Log ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ï‡∏≤‡∏£‡∏≤‡∏á loan_logs ‡πÅ‡∏•‡πâ‡∏ß)
        // üåü ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏ä‡πâ supabaseClient
        await supabaseClient.from('loan_logs').insert([{
            computer_id: selectedComputerId,
            borrower_name: borrowerName,
            borrower_dept: borrowerDept,
            status: 'Borrowed'
        }]);

        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏∑‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏ã‡πà‡∏≠‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏° ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì
        document.getElementById('loanFormArea').style.display = 'none';
        document.getElementById('borrowedAssetId').textContent = selectedComputerId;
        document.getElementById('successMessage').style.display = 'block';

    } catch (error) {
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ' + error.message);
    }
}
